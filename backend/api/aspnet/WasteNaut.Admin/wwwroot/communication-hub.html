<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Communication Hub - WasteNaut</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../resources/styles/main.css" />
    <style>
      /* Ensure consistent icon sizing in messages */
      .message .bi {
        width: 14px !important;
        height: 14px !important;
        display: inline-block !important;
        text-align: center !important;
      }
      
      /* Ensure consistent message container sizing */
      .message .rounded-circle {
        min-width: 30px !important;
        max-width: 30px !important;
        min-height: 30px !important;
        max-height: 30px !important;
        flex-shrink: 0 !important;
      }
      
      /* Ensure consistent message bubble sizing */
      .message .rounded {
        max-width: 70% !important;
        word-wrap: break-word !important;
      }
      
        /* Fix flexbox layout for consistent spacing */
        .message .d-flex {
          align-items: flex-start !important;
        }
        
        .message.sent .d-flex {
          justify-content: flex-end !important;
        }
        
        .message.received .d-flex {
          justify-content: flex-start !important;
        }
        
        /* Conversation list styling */
        .list-group-item {
          cursor: pointer !important;
          transition: all 0.2s ease !important;
        }
        
        .list-group-item:hover {
          background-color: rgba(255, 255, 255, 0.1) !important;
          transform: translateX(2px) !important;
        }
        
        .list-group-item.active-conversation {
          background-color: rgba(0, 255, 136, 0.2) !important;
          border-left: 3px solid #00ff88 !important;
        }
        
        .list-group-item.active-conversation:hover {
          background-color: rgba(0, 255, 136, 0.3) !important;
        }
        
        /* File download link styling */
        .message a[download] {
          color: #00ff88 !important;
          transition: color 0.2s ease !important;
        }
        
        .message a[download]:hover {
          color: #00d4aa !important;
          text-decoration: underline !important;
        }
    </style>
  </head>
  <body>
    <!-- Header Container -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <div class="container py-4">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex align-items-center mb-3">
            <div class="bg-info rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
              <i class="bi bi-chat-dots text-white fs-5"></i>
            </div>
            <div>
              <h1 class="h3 mb-1 text-gradient">Communication Hub</h1>
              <p class="text-muted mb-0">Secure space-age communication network</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <!-- Active Conversations -->
        <div class="col-lg-4">
          <div class="card border-0 bg-dark h-100">
            <div class="card-header bg-dark border-bottom">
              <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-list-ul me-2"></i>Active Conversations
              </h5>
                <div class="dropdown">
                  <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus-circle me-1"></i>New Conversation
                  </button>
                  <ul class="dropdown-menu dropdown-menu-dark">
                    <li><a class="dropdown-item" href="#" onclick="startNewConversation('John Smith')">
                      <i class="bi bi-person me-2"></i>John Smith
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="startNewConversation('Maria Garcia')">
                      <i class="bi bi-person me-2"></i>Maria Garcia
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="startNewConversation('David Chen')">
                      <i class="bi bi-person me-2"></i>David Chen
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="startNewConversation('Emily Johnson')">
                      <i class="bi bi-person me-2"></i>Emily Johnson
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="startNewConversation('Michael Brown')">
                      <i class="bi bi-person me-2"></i>Michael Brown
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="startNewConversationWithCustomName()">
                      <i class="bi bi-plus me-2"></i>Custom Name...
                    </a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="list-group list-group-flush">
                <!-- Conversations will be loaded dynamically -->
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Interface -->
        <div class="col-lg-8">
          <div class="card border-0 bg-dark h-100">
            <div class="card-header bg-dark border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                    <i class="bi bi-person text-white"></i>
                  </div>
                  <div>
                    <h6 class="mb-0">Sarah Johnson</h6>
                    <small class="text-success">Online</small>
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-info" onclick="showComingSoon('Video Call')">
                    <i class="bi bi-camera-video"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-warning" onclick="showComingSoon('Voice Call')">
                    <i class="bi bi-telephone"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="showComingSoon('More Options')">
                    <i class="bi bi-three-dots"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-0" style="height: 400px; overflow-y: auto;">
              <!-- Chat Messages -->
              <div class="p-3">
                <div class="message received mb-3">
                  <div class="d-flex">
                    <div class="bg-secondary rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px;">
                      <i class="bi bi-person text-white" style="font-size: 14px;"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="bg-secondary rounded p-2">
                        <p class="mb-1">Hi! I have about 50 lbs of fresh vegetables that I'd like to donate. They're from my garden and are still very fresh.</p>
                        <small class="text-muted">2:30 PM</small>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="message sent mb-3">
                  <div class="d-flex justify-content-end">
                    <div class="flex-grow-1 text-end">
                      <div class="bg-primary rounded p-2">
                        <p class="mb-1">That's wonderful! We'd love to accept your donation. When would be a good time for pickup?</p>
                        <small class="text-muted">2:32 PM</small>
                      </div>
                    </div>
                    <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center ms-2" style="width: 30px; height: 30px;">
                      <i class="bi bi-person text-white" style="font-size: 14px;"></i>
                    </div>
                  </div>
                </div>

                <div class="message received mb-3">
                  <div class="d-flex">
                    <div class="bg-secondary rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px;">
                      <i class="bi bi-person text-white" style="font-size: 14px;"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="bg-secondary rounded p-2">
                        <p class="mb-1">I'm available tomorrow morning between 9-11 AM. My address is 123 Oak Street. Should I leave them on the porch?</p>
                        <small class="text-muted">2:35 PM</small>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="message sent mb-3">
                  <div class="d-flex justify-content-end">
                    <div class="flex-grow-1 text-end">
                      <div class="bg-primary rounded p-2">
                        <p class="mb-1">Perfect! We'll send our pickup team tomorrow at 10 AM. Yes, please leave them on the porch and we'll collect them. Thank you so much for your generous donation!</p>
                        <small class="text-muted">2:37 PM</small>
                      </div>
                    </div>
                    <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center ms-2" style="width: 30px; height: 30px;">
                      <i class="bi bi-person text-white" style="font-size: 14px;"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer bg-dark border-top">
              <!-- File Preview Area -->
              <div id="filePreviewArea" class="mb-2" style="display: none;">
                <div class="d-flex flex-wrap gap-2" id="filePreviewList">
                  <!-- File previews will be added here -->
                </div>
              </div>
              
              <div class="d-flex gap-2">
                <input type="text" class="form-control" placeholder="Type your message..." id="messageInput">
                <button class="btn btn-primary" onclick="sendMessage()">
                  <i class="bi bi-send"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()">
                  <i class="bi bi-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,.pdf,.doc,.docx,.txt" onchange="handleFileSelection(event)">
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Bootstrap JS bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <!-- Custom JS -->
    <script src="../resources/scripts/main.js"></script>
    <script>
      // Communication hub functionality
      document.addEventListener('DOMContentLoaded', function() {
        loadConversations();
        // Initialize with the first conversation and load any saved messages
        loadConversationMessages(currentConversationId);
      });

      function loadConversations() {
        // Load conversations (in real app, this would come from backend)
        console.log('Loading conversations...');
        
        // Get the conversations list container
        const conversationsList = document.querySelector('.list-group-flush');
        if (!conversationsList) {
          console.error('Conversations list container not found');
          return;
        }
        
        // Clear existing conversations
        conversationsList.innerHTML = '';
        
        // Load static conversations (IDs 1, 2, 3)
        const staticConversations = [
          {
            id: 1,
            name: 'Sarah Johnson',
            status: 'Online',
            statusClass: 'text-success',
            avatarBg: 'bg-success',
            lastMessage: 'Fresh produce donation pickup',
            timestamp: formatRelativeTime(new Date(Date.now() - 2 * 60 * 1000).toISOString()), // 2 minutes ago
            unreadCount: 2
          },
          {
            id: 2,
            name: 'Food Bank Admin',
            status: 'Offline',
            statusClass: 'text-danger',
            avatarBg: 'bg-danger',
            lastMessage: 'Request for assistance details',
            timestamp: formatRelativeTime(new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()), // 1 day ago
            unreadCount: 0
          },
          {
            id: 3,
            name: 'Local Shelter',
            status: 'Away',
            statusClass: 'text-warning',
            avatarBg: 'bg-warning',
            lastMessage: 'Urgent need for blankets',
            timestamp: formatRelativeTime(new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()), // 3 days ago
            unreadCount: 0
          }
        ];
        
        // Add static conversations
        staticConversations.forEach(conversation => {
          const element = createConversationElement(conversation);
          conversationsList.appendChild(element);
        });
        
        // Load dynamic conversations from localStorage
        loadDynamicConversations(conversationsList);
        
        // Set first conversation as active
        if (conversationsList.firstChild) {
          conversationsList.firstChild.classList.add('active-conversation');
        }
        
        // Start periodic timestamp updates
        startTimestampUpdates();
      }
      
      function startTimestampUpdates() {
        // Update timestamps every minute
        setInterval(() => {
          updateAllConversationTimestamps();
        }, 60000); // 60 seconds
      }
      
      function updateAllConversationTimestamps() {
        const conversationsList = document.querySelector('.list-group-flush');
        const conversationElements = conversationsList.querySelectorAll('.list-group-item');
        
        conversationElements.forEach(element => {
          const onclickAttr = element.getAttribute('onclick');
          if (onclickAttr) {
            // Extract conversation ID from onclick attribute
            const match = onclickAttr.match(/selectConversation\((\d+)/);
            if (match) {
              const conversationId = parseInt(match[1]);
              const timeElement = element.querySelector('small.text-muted');
              
              if (timeElement) {
                const newTimestamp = getLastMessageTime(conversationId);
                timeElement.textContent = newTimestamp;
              }
            }
          }
        });
      }
      
      function loadDynamicConversations(conversationsList) {
        // Get all localStorage keys that start with 'conversation_'
        const keys = Object.keys(localStorage);
        const conversationKeys = keys.filter(key => key.startsWith('conversation_') && !key.includes('_messages'));
        
        conversationKeys.forEach(key => {
          const conversationId = parseInt(key.replace('conversation_', ''));
          
          // Skip static conversations (IDs 1, 2, 3)
          if (conversationId <= 3) return;
          
          try {
            const conversationData = JSON.parse(localStorage.getItem(key));
            
            // Create conversation element
            const conversation = {
              id: conversationId,
              name: conversationData.name,
              status: conversationData.status || 'Online',
              statusClass: conversationData.statusClass || 'text-success',
              avatarBg: conversationData.avatarBg || 'bg-primary',
              lastMessage: getLastMessage(conversationId),
              timestamp: getLastMessageTime(conversationId),
              unreadCount: 0
            };
            
            const element = createConversationElement(conversation);
            conversationsList.appendChild(element);
            
          } catch (error) {
            console.error('Error loading conversation', conversationId, ':', error);
          }
        });
      }
      
      function getLastMessage(conversationId) {
        const savedMessages = getSavedMessages(conversationId);
        if (savedMessages && savedMessages.length > 0) {
          const lastMessage = savedMessages[savedMessages.length - 1];
          return lastMessage.text || 'New conversation started';
        }
        return 'New conversation started';
      }
      
      function getLastMessageTime(conversationId) {
        const savedMessages = getSavedMessages(conversationId);
        if (savedMessages && savedMessages.length > 0) {
          const lastMessage = savedMessages[savedMessages.length - 1];
          const messageTime = lastMessage.time || lastMessage.timestamp;
          return formatRelativeTime(messageTime);
        }
        return formatRelativeTime(new Date().toISOString());
      }
      
      function formatRelativeTime(timeString) {
        try {
          // Parse the time string (could be ISO string, time string, or relative string)
          let messageTime;
          
          if (timeString.includes('T') || timeString.includes('Z')) {
            // ISO string
            messageTime = new Date(timeString);
          } else if (timeString.includes(':')) {
            // Time string like "2:30 PM"
            const today = new Date();
            const [time, period] = timeString.split(' ');
            const [hours, minutes] = time.split(':');
            messageTime = new Date(today);
            messageTime.setHours(period === 'PM' && hours !== '12' ? parseInt(hours) + 12 : parseInt(hours));
            messageTime.setMinutes(parseInt(minutes));
            messageTime.setSeconds(0);
          } else if (timeString.includes('ago') || timeString.includes('min') || timeString.includes('hour')) {
            // Already a relative time string
            return timeString;
          } else {
            // Fallback to current time
            messageTime = new Date();
          }
          
          const now = new Date();
          const diffMs = now - messageTime;
          const diffMinutes = Math.floor(diffMs / (1000 * 60));
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          
          if (diffMinutes < 1) {
            return 'Just now';
          } else if (diffMinutes < 60) {
            return `${diffMinutes} min ago`;
          } else if (diffHours < 24) {
            return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
          } else if (diffDays < 7) {
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
          } else {
            return messageTime.toLocaleDateString();
          }
        } catch (error) {
          console.error('Error formatting time:', error);
          return 'Recently';
        }
      }

      // Global variable to track current conversation
      let currentConversationId = 1;
      
      // Global variable to track attached files
      let attachedFiles = [];
      
      function selectConversation(conversationId, element) {
        console.log('selectConversation called with ID:', conversationId, 'element:', element);
        
        // Update current conversation ID
        currentConversationId = conversationId;
        
        // Remove active class from all conversations
        document.querySelectorAll('.active-conversation').forEach(el => {
          console.log('Removing active class from:', el);
          el.classList.remove('active-conversation');
        });
        
        // Add active class to selected conversation
        console.log('Adding active class to:', element);
        element.classList.add('active-conversation');
        
        // Verify the class was added
        console.log('Element classes after adding active:', element.className);
        
        // Load conversation messages based on ID
        loadConversationMessages(conversationId);
      }
      
      function loadConversationMessages(conversationId) {
        const messagesContainer = document.querySelector('.col-lg-8 .card-body .p-3');
        if (!messagesContainer) {
          console.error('Messages container not found');
          return;
        }
        
        // Clear existing messages
        messagesContainer.innerHTML = '';
        
        // Get conversation data
        const conversationData = getConversationData(conversationId);
        
        // Update chat header
        updateChatHeader(conversationData);
        
        // Get saved sent messages for this conversation
        const savedMessages = getSavedMessages(conversationId);
        
        // For static conversations (1, 2, 3), use original messages + saved messages
        // For dynamic conversations, use only saved messages
        let allMessages;
        if (conversationId <= 3) {
          // Static conversations: combine original with saved
          allMessages = [...conversationData.messages, ...savedMessages];
        } else {
          // Dynamic conversations: use only saved messages
          allMessages = savedMessages.length > 0 ? savedMessages : conversationData.messages;
        }
        
        // Sort messages by timestamp (if available) or keep original order
        allMessages.sort((a, b) => {
          // If both have timestamps, sort by time
          if (a.timestamp && b.timestamp) {
            return new Date(a.timestamp) - new Date(b.timestamp);
          }
          // Otherwise keep original order (original messages first, then saved)
          return 0;
        });
        
        // Add messages to container
        allMessages.forEach(message => {
          addMessageToChat(message);
        });
        
        // Scroll to bottom
        const scrollContainer = messagesContainer.parentElement;
        scrollContainer.scrollTop = scrollContainer.scrollHeight;
      }
      
      function getConversationData(conversationId) {
        // Check if this is a dynamically created conversation
        if (conversationId > 1000) { // Assuming dynamic IDs are timestamps (large numbers)
          // Try to get conversation data from localStorage or return default
          const savedConversation = localStorage.getItem(`conversation_${conversationId}`);
          if (savedConversation) {
            const conversationData = JSON.parse(savedConversation);
            
            // Also load saved messages for this conversation
            const savedMessages = getSavedMessages(conversationId);
            if (savedMessages && savedMessages.length > 0) {
              conversationData.messages = savedMessages;
            }
            
            return conversationData;
          }
          
          // Return default new conversation data
          return {
            name: 'New Contact',
            status: 'Online',
            statusClass: 'text-success',
            avatarBg: 'bg-primary',
            messages: [
              {
                type: 'received',
                text: 'Hello! How can I help you today?',
                time: new Date().toLocaleTimeString()
              }
            ]
          };
        }
        
        const conversations = {
          1: {
            name: 'Sarah Johnson',
            status: 'Online',
            statusClass: 'text-success',
            avatarBg: 'bg-success',
            messages: [
              {
                type: 'received',
                text: 'Hi! I have about 50 lbs of fresh vegetables that I\'d like to donate. They\'re from my garden and are still very fresh.',
                time: '2:30 PM'
              },
              {
                type: 'sent',
                text: 'That\'s wonderful! We\'d love to accept your donation. When would be a good time for pickup?',
                time: '2:32 PM'
              },
              {
                type: 'received',
                text: 'I\'m available tomorrow morning between 9-11 AM. My address is 123 Oak Street. Should I leave them on the porch?',
                time: '2:35 PM'
              },
              {
                type: 'sent',
                text: 'Perfect! We\'ll send our pickup team tomorrow at 10 AM. Yes, please leave them on the porch and we\'ll collect them. Thank you so much for your generous donation!',
                time: '2:37 PM'
              }
            ]
          },
          2: {
            name: 'Community Center',
            status: 'Offline',
            statusClass: 'text-muted',
            avatarBg: 'bg-warning',
            messages: [
              {
                type: 'received',
                text: 'Hello! We\'re organizing a bulk food distribution event next week and could use some additional supplies.',
                time: '1:15 PM'
              },
              {
                type: 'sent',
                text: 'We\'d be happy to help! What specific items do you need for the distribution?',
                time: '1:18 PM'
              },
              {
                type: 'received',
                text: 'We\'re looking for non-perishable items like canned goods, pasta, rice, and cereal. Any quantity would be helpful.',
                time: '1:20 PM'
              }
            ]
          },
          3: {
            name: 'Green Grocery Store',
            status: 'Online',
            statusClass: 'text-success',
            avatarBg: 'bg-info',
            messages: [
              {
                type: 'received',
                text: 'Good morning! We have fresh bread that\'s approaching its sell-by date. Would you like us to set it aside for donation?',
                time: '9:30 AM'
              },
              {
                type: 'sent',
                text: 'Absolutely! Fresh bread is always welcome. How many loaves are we talking about?',
                time: '9:32 AM'
              },
              {
                type: 'received',
                text: 'We have about 20 loaves of various types - sourdough, whole wheat, and white bread.',
                time: '9:35 AM'
              },
              {
                type: 'sent',
                text: 'Perfect! We\'ll arrange pickup for this afternoon. Thank you for thinking of us!',
                time: '9:37 AM'
              }
            ]
          }
        };
        
        return conversations[conversationId] || conversations[1];
      }
      
      function updateChatHeader(conversationData) {
        const headerName = document.querySelector('.col-lg-8 .card-header h6');
        const headerStatus = document.querySelector('.col-lg-8 .card-header small');
        const headerAvatar = document.querySelector('.col-lg-8 .card-header .rounded-circle');
        
        if (headerName) headerName.textContent = conversationData.name;
        if (headerStatus) {
          headerStatus.textContent = conversationData.status;
          headerStatus.className = conversationData.statusClass;
        }
        if (headerAvatar) {
          headerAvatar.className = `${conversationData.avatarBg} rounded-circle d-inline-flex align-items-center justify-content-center me-3`;
        }
      }
      
      function saveMessage(conversationId, message, type) {
        const messageData = {
          text: message,
          type: type,
          time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
          timestamp: new Date().toISOString()
        };
        
        // Get existing saved messages for this conversation
        const savedMessages = getSavedMessages(conversationId);
        
        // Add new message
        savedMessages.push(messageData);
        
        // Save back to localStorage
        const key = `conversation_${conversationId}_messages`;
        localStorage.setItem(key, JSON.stringify(savedMessages));
        
        console.log('Message saved for conversation', conversationId, ':', messageData);
      }
      
      function getSavedMessages(conversationId) {
        const key = `conversation_${conversationId}_messages`;
        const saved = localStorage.getItem(key);
        return saved ? JSON.parse(saved) : [];
      }
      
      function handleFileSelection(event) {
        const files = Array.from(event.target.files);
        
        files.forEach(file => {
          // Validate file size (max 10MB)
          if (file.size > 10 * 1024 * 1024) {
            alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
            return;
          }
          
          // Read file content as data URL for persistence
          const reader = new FileReader();
          reader.onload = function(e) {
            const fileData = {
              file: file,
              content: e.target.result, // This is the data URL
              dataUrl: e.target.result  // Store as data URL for downloads
            };
            
            // Add file to attached files
            attachedFiles.push(fileData);
            
            // Create file preview
            createFilePreview(fileData);
          };
          reader.readAsDataURL(file);
        });
        
        // Show file preview area if files are attached
        if (attachedFiles.length > 0) {
          document.getElementById('filePreviewArea').style.display = 'block';
        }
        
        // Clear the file input
        event.target.value = '';
      }
      
      function createFilePreview(fileData) {
        const previewList = document.getElementById('filePreviewList');
        const previewDiv = document.createElement('div');
        previewDiv.className = 'file-preview bg-secondary rounded p-2 d-flex align-items-center gap-2';
        previewDiv.style.cssText = 'max-width: 200px; font-size: 0.9rem;';
        
        // Get file icon based on type
        const fileIcon = getFileIcon(fileData.file.type);
        
        previewDiv.innerHTML = `
          <i class="bi ${fileIcon} text-primary"></i>
          <div class="flex-grow-1 text-truncate">
            <div class="fw-bold text-light">${fileData.file.name}</div>
            <small class="text-muted">${formatFileSize(fileData.file.size)}</small>
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="removeFile('${fileData.file.name}')">
            <i class="bi bi-x"></i>
          </button>
        `;
        
        previewList.appendChild(previewDiv);
      }
      
      function getFileIcon(fileType) {
        if (fileType.startsWith('image/')) return 'bi-image';
        if (fileType.includes('pdf')) return 'bi-file-pdf';
        if (fileType.includes('word') || fileType.includes('document')) return 'bi-file-word';
        if (fileType.includes('text')) return 'bi-file-text';
        return 'bi-file';
      }
      
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      
      function removeFile(fileName) {
        // Remove file from attached files array
        attachedFiles = attachedFiles.filter(fileData => fileData.file.name !== fileName);
        
        // Remove preview from DOM
        const previews = document.querySelectorAll('.file-preview');
        previews.forEach(preview => {
          if (preview.textContent.includes(fileName)) {
            preview.remove();
          }
        });
        
        // Hide preview area if no files left
        if (attachedFiles.length === 0) {
          document.getElementById('filePreviewArea').style.display = 'none';
        }
      }

      function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        // Don't send if no message and no files
        if (!message && attachedFiles.length === 0) {
          return;
        }
        
        // Create message data with files
        const messageData = {
          text: message || '',
          type: 'sent',
          time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
          timestamp: new Date().toISOString(),
          files: attachedFiles.map(fileData => ({
            name: fileData.file.name,
            size: fileData.file.size,
            type: fileData.file.type,
            lastModified: fileData.file.lastModified,
            content: fileData.content,
            dataUrl: fileData.dataUrl
          }))
        };
        
        // Save message to localStorage
        saveMessageWithFiles(currentConversationId, messageData);
        
        // Add message to chat
        addMessageToChat(messageData);
        
        // Update conversation list to reflect new message and timestamp
        updateConversationInList(currentConversationId, messageData.text || 'File sent');
        
        // Clear input and attached files
          messageInput.value = '';
        clearAttachedFiles();
      }
      
      function saveMessageWithFiles(conversationId, messageData) {
        // Get existing saved messages for this conversation
        const savedMessages = getSavedMessages(conversationId);
        
        // Add new message
        savedMessages.push(messageData);
        
        // Save back to localStorage
        const key = `conversation_${conversationId}_messages`;
        localStorage.setItem(key, JSON.stringify(savedMessages));
        
        console.log('Message with files saved for conversation', conversationId, ':', messageData);
      }
      
      function updateConversationInList(conversationId, lastMessage) {
        // Find the conversation element in the list
        const conversationsList = document.querySelector('.list-group-flush');
        const conversationElements = conversationsList.querySelectorAll('.list-group-item');
        
        conversationElements.forEach(element => {
          // Check if this element corresponds to the current conversation
          const onclickAttr = element.getAttribute('onclick');
          if (onclickAttr && onclickAttr.includes(`selectConversation(${conversationId}`)) {
            // Update the last message and timestamp
            const messageElement = element.querySelector('p.mb-1.text-muted.small');
            const timeElement = element.querySelector('small.text-muted');
            
            if (messageElement) {
              messageElement.textContent = lastMessage;
            }
            
            if (timeElement) {
              timeElement.textContent = 'Just now';
            }
            
            // Move this conversation to the top of the list
            conversationsList.insertBefore(element, conversationsList.firstChild);
          }
        });
      }

      function addMessageToChat(messageData, type) {
        // Find the messages container specifically (the chat messages area)
        const messagesContainer = document.querySelector('.col-lg-8 .card-body .p-3');
        if (!messagesContainer) {
          console.error('Messages container not found');
          return;
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${messageData.type || type} mb-3`;
        
        const timestamp = messageData.time || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const messageText = messageData.text || messageData;
        
        if (messageData.type === 'sent' || type === 'sent') {
          let filesHtml = '';
          if (messageData.files && messageData.files.length > 0) {
            filesHtml = `
              <div class="mt-2">
                ${messageData.files.map(file => `
                  <div class="d-flex align-items-center gap-2 bg-primary bg-opacity-25 rounded p-2 mb-1">
                    <i class="bi ${getFileIcon(file.type)} text-primary"></i>
                    <div class="flex-grow-1">
                      <a href="${file.dataUrl || file.content}" download="${file.name}" class="fw-bold text-light small text-decoration-none">
                        ${file.name}
                      </a>
                      <small class="text-muted d-block">${formatFileSize(file.size)}</small>
                    </div>
                  </div>
                `).join('')}
              </div>
            `;
          }
          
          messageDiv.innerHTML = `
            <div class="d-flex justify-content-end">
              <div class="flex-grow-1 text-end">
                <div class="bg-primary rounded p-2">
                  ${messageText ? `<p class="mb-1">${messageText}</p>` : ''}
                  ${filesHtml}
                  <small class="text-muted">${timestamp}</small>
                </div>
              </div>
              <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center ms-2" style="width: 30px; height: 30px;">
                <i class="bi bi-person text-white" style="font-size: 14px;"></i>
              </div>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="d-flex">
              <div class="bg-secondary rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px;">
                <i class="bi bi-person text-white" style="font-size: 14px;"></i>
              </div>
              <div class="flex-grow-1">
                <div class="bg-secondary rounded p-2">
                  <p class="mb-1">${messageText}</p>
                  <small class="text-muted">${timestamp}</small>
                </div>
              </div>
            </div>
          `;
        }
        
        messagesContainer.appendChild(messageDiv);
        
        // Scroll to bottom of the messages container
        const scrollContainer = messagesContainer.parentElement;
        scrollContainer.scrollTop = scrollContainer.scrollHeight;
      }

      // Allow sending message with Enter key
      document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      function startNewConversation(contactName = null) {
        // If no contact name provided, show prompt for custom name
        if (!contactName) {
          contactName = prompt('Enter the name of the person you want to start a conversation with:');
          
          if (!contactName || contactName.trim() === '') {
            return; // User cancelled or entered empty name
          }
        }
        
        // Generate a new conversation ID (simple increment for demo)
        const newConversationId = Date.now(); // Use timestamp as unique ID
        
        // Create new conversation data
        const newConversation = {
          id: newConversationId,
          name: contactName.trim(),
          lastMessage: 'New conversation started',
          timestamp: new Date().toLocaleTimeString(),
          messages: [
            {
              type: 'received',
              message: `Hello! I'm ${contactName.trim()}. How can I help you today?`,
              timestamp: new Date().toLocaleTimeString()
            }
          ]
        };
        
        // Save conversation data to localStorage for getConversationData to retrieve
        const conversationData = {
          name: contactName.trim(),
          status: 'Online',
          statusClass: 'text-success',
          avatarBg: 'bg-primary',
          messages: [
            {
              type: 'received',
              text: `Hello! I'm ${contactName.trim()}. How can I help you today?`,
              time: new Date().toLocaleTimeString()
            }
          ]
        };
        localStorage.setItem(`conversation_${newConversationId}`, JSON.stringify(conversationData));
        
        // Add new conversation to the conversations list
        const conversationsList = document.querySelector('.list-group-flush');
        const newConversationElement = createConversationElement(newConversation);
        conversationsList.appendChild(newConversationElement);
        
        // Select the new conversation
        selectConversation(newConversationId, newConversationElement);
        
        // Show success message
        if (window.headerManager && window.headerManager.showNotification) {
          window.headerManager.showNotification(`New conversation started with ${contactName.trim()}!`, 'success');
        } else {
          showPageNotification(`New conversation started with ${contactName.trim()}!`, 'success');
        }
      }
      
      function startNewConversationWithCustomName() {
        // Show custom name input modal instead of prompt
        showCustomNameModal();
      }
      
      function showCustomNameModal() {
        // Create modal HTML
        const modalHTML = `
          <div class="modal fade" id="customNameModal" tabindex="-1" aria-labelledby="customNameModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                  <h5 class="modal-title" id="customNameModalLabel">
                    <i class="bi bi-person-plus me-2"></i>Start New Conversation
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="contactNameInput" class="form-label">Contact Name</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="contactNameInput" 
                           placeholder="Enter the person's name..." autofocus>
                  </div>
                </div>
                <div class="modal-footer border-secondary">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" onclick="createCustomConversation()">
                    <i class="bi bi-plus-circle me-1"></i>Start Conversation
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Remove existing modal if it exists
        const existingModal = document.getElementById('customNameModal');
        if (existingModal) {
          existingModal.remove();
        }
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('customNameModal'));
        modal.show();
        
        // Focus on input and handle Enter key
        document.getElementById('contactNameInput').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            createCustomConversation();
          }
        });
      }
      
      function createCustomConversation() {
        const contactNameInput = document.getElementById('contactNameInput');
        const contactName = contactNameInput.value.trim();
        
        if (!contactName) {
          showPageNotification('Please enter a contact name.', 'warning');
          contactNameInput.focus();
          return;
        }
        
        // Hide modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('customNameModal'));
        modal.hide();
        
        // Start conversation
        startNewConversation(contactName);
        
        // Clean up modal
        setTimeout(() => {
          const modalElement = document.getElementById('customNameModal');
          if (modalElement) {
            modalElement.remove();
          }
        }, 300);
      }
      
      function showPageNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        notification.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }
      
      function createConversationElement(conversation) {
        const element = document.createElement('div');
        element.className = 'list-group-item bg-dark border-secondary';
        element.onclick = () => selectConversation(conversation.id, element);
        
        // Generate a random color for the avatar if not specified
        const avatarBg = conversation.avatarBg || 'bg-primary';
        
        element.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="${avatarBg} rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
              <i class="bi bi-person text-white"></i>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1 text-white">${conversation.name}</h6>
                  <p class="mb-1 text-muted small">${conversation.lastMessage}</p>
                  <small class="${conversation.statusClass || 'text-success'}">${conversation.status || 'Online'}</small>
                </div>
                <div class="text-end">
                  ${conversation.unreadCount > 0 ? `<span class="badge bg-primary">${conversation.unreadCount}</span><br>` : ''}
                  <small class="text-muted">${conversation.timestamp}</small>
                </div>
              </div>
            </div>
          </div>
        `;
        
        return element;
      }

      function showComingSoon(feature) {
        SupplyConnect.Utils.showAlert(`${feature} feature coming soon!`, 'info');
      }
    </script>

    <!-- Shared Header Scripts -->
    <script src="../resources/scripts/auth.js"></script>
    <script src="../resources/scripts/header-include.js"></script>
    <script src="../resources/scripts/header.js"></script>
    
    <!-- Page Protection -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Protect this page - allow both individual and organization users
        if (!window.authManager || !window.authManager.isAuthenticated()) {
          window.location.href = 'index.html';
          return;
        }
        
        const userRole = window.authManager.getUserRole();
        if (userRole !== 'individual' && userRole !== 'org') {
          window.location.href = 'index.html';
          return;
        }
      });
    </script>
  </body>
</html>
