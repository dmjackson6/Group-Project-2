<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Management - WasteNaut Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../Resources/Styles/main.css" rel="stylesheet">
    <link href="../Resources/Styles/admin.css" rel="stylesheet">
</head>
<body>
    <!-- Admin Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark admin-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-rocket-takeoff me-2"></i>WasteNaut Admin
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="adminNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people me-1"></i>Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orgs.html">
                            <i class="bi bi-building me-1"></i>Organizations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="reports.html">
                            <i class="bi bi-flag me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="matches.html">
                            <i class="bi bi-diagram-3 me-1"></i>Matches
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">
                            <i class="bi bi-gear me-1"></i>Settings
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="adminUserName">Admin User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="adminAPI.logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="admin-content">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-gradient">Reports Management</h1>
                    <p class="text-muted">Review and triage user reports, safety concerns, and violations</p>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="reportSearch" placeholder="Search reports...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="investigating">Investigating</option>
                        <option value="resolved">Resolved</option>
                        <option value="dismissed">Dismissed</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="priorityFilter">
                        <option value="">All Priority</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="safety">Safety</option>
                        <option value="fraud">Fraud</option>
                        <option value="inappropriate">Inappropriate</option>
                        <option value="technical">Technical</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="assignToMe()">
                        <i class="bi bi-person-check me-1"></i>Assign to Me
                    </button>
                </div>
            </div>

            <!-- Reports Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-flag me-2"></i>Reports
                        <span class="badge bg-primary ms-2" id="reportCount">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Report</th>
                                    <th>Type</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Reporter</th>
                                    <th>Assigned To</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">Loading reports...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-flag me-2"></i>Report Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="reportModalBody">
                    <!-- Report details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="changeStatusBtn">
                        <i class="bi bi-arrow-repeat me-2"></i>Change Status
                    </button>
                    <button type="button" class="btn btn-info" id="addNoteBtn">
                        <i class="bi bi-chat-text me-2"></i>Add Note
                    </button>
                    <button type="button" class="btn btn-success" id="resolveBtn">
                        <i class="bi bi-check-circle me-2"></i>Resolve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Change Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-arrow-repeat me-2"></i>Change Status
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="statusForm">
                        <div class="mb-3">
                            <label for="newStatus" class="form-label">New Status</label>
                            <select class="form-select" id="newStatus" required>
                                <option value="pending">Pending</option>
                                <option value="investigating">Investigating</option>
                                <option value="resolved">Resolved</option>
                                <option value="dismissed">Dismissed</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="statusNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="statusNotes" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveStatusBtn">
                        <i class="bi bi-save me-2"></i>Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-chat-text me-2"></i>Add Note
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="noteForm">
                        <div class="mb-3">
                            <label for="noteText" class="form-label">Note</label>
                            <textarea class="form-control" id="noteText" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="noteType" class="form-label">Type</label>
                            <select class="form-select" id="noteType">
                                <option value="internal">Internal</option>
                                <option value="public">Public</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNoteBtn">
                        <i class="bi bi-save me-2"></i>Add Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../Resources/Scripts/main.js"></script>
    <script src="admin-main.js"></script>
    <script src="mock-api.js"></script>
    <script>
        let currentReport = null;
        let allReports = [];

        // Check authentication
        if (!localStorage.getItem('adminToken')) {
            window.location.href = 'login.html';
        }

        // Load reports
        async function loadReports() {
            try {
                allReports = await adminAPI.getReports();
                renderReports(allReports);
                document.getElementById('reportCount').textContent = allReports.length;
            } catch (error) {
                console.error('Error loading reports:', error);
                showAlert('Error loading reports', 'danger');
            }
        }

        // Render reports table
        function renderReports(reports) {
            const tbody = document.getElementById('reportsTable');
            tbody.innerHTML = reports.map(report => `
                <tr>
                    <td>
                        <div>
                            <div class="fw-bold">${report.title}</div>
                            <small class="text-muted">ID: ${report.id}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${report.type === 'safety' ? 'danger' : report.type === 'fraud' ? 'warning' : report.type === 'inappropriate' ? 'info' : 'secondary'}">
                            ${report.type}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${report.priority === 'critical' ? 'danger' : report.priority === 'high' ? 'warning' : report.priority === 'medium' ? 'info' : 'secondary'}">
                            ${report.priority}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${report.status === 'resolved' ? 'success' : report.status === 'investigating' ? 'warning' : report.status === 'dismissed' ? 'secondary' : 'primary'}">
                            ${report.status}
                        </span>
                    </td>
                    <td>
                        <div>${report.reporter.name}</div>
                        <small class="text-muted">${report.reporter.email}</small>
                    </td>
                    <td>
                        ${report.assignedTo ? report.assignedTo.name : '<span class="text-muted">Unassigned</span>'}
                    </td>
                    <td>${new Date(report.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewReport(${report.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // View report details
        async function viewReport(reportId) {
            try {
                currentReport = allReports.find(r => r.id === reportId);
                if (!currentReport) return;

                const reportDetails = await adminAPI.getReport(reportId);
                
                document.getElementById('reportModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Report Details</h6>
                            <div class="mb-3">
                                <strong>Title:</strong> ${reportDetails.title}
                            </div>
                            <div class="mb-3">
                                <strong>Description:</strong><br>
                                <div class="bg-light p-3 rounded">${reportDetails.description}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Type:</strong> 
                                    <span class="badge bg-${reportDetails.type === 'safety' ? 'danger' : reportDetails.type === 'fraud' ? 'warning' : reportDetails.type === 'inappropriate' ? 'info' : 'secondary'}">
                                        ${reportDetails.type}
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Priority:</strong> 
                                    <span class="badge bg-${reportDetails.priority === 'critical' ? 'danger' : reportDetails.priority === 'high' ? 'warning' : reportDetails.priority === 'medium' ? 'info' : 'secondary'}">
                                        ${reportDetails.priority}
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Status:</strong> 
                                    <span class="badge bg-${reportDetails.status === 'resolved' ? 'success' : reportDetails.status === 'investigating' ? 'warning' : reportDetails.status === 'dismissed' ? 'secondary' : 'primary'}">
                                        ${reportDetails.status}
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Assigned To:</strong> 
                                    ${reportDetails.assignedTo ? reportDetails.assignedTo.name : 'Unassigned'}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Reporter Information</h6>
                            <div class="mb-2">
                                <strong>Name:</strong> ${reportDetails.reporter.name}
                            </div>
                            <div class="mb-2">
                                <strong>Email:</strong> ${reportDetails.reporter.email}
                            </div>
                            <div class="mb-2">
                                <strong>Phone:</strong> ${reportDetails.reporter.phone || 'Not provided'}
                            </div>
                            <div class="mb-3">
                                <strong>Reported:</strong> ${new Date(reportDetails.createdAt).toLocaleString()}
                            </div>
                            
                            <h6 class="mt-4">Notes</h6>
                            <div id="reportNotes">
                                ${reportDetails.notes.map(note => `
                                    <div class="card mb-2">
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">${note.author}</small>
                                                <small class="text-muted">${new Date(note.createdAt).toLocaleString()}</small>
                                            </div>
                                            <div class="mt-1">${note.text}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                new bootstrap.Modal(document.getElementById('reportModal')).show();
            } catch (error) {
                console.error('Error loading report details:', error);
                showAlert('Error loading report details', 'danger');
            }
        }

        // Change status
        document.getElementById('changeStatusBtn').addEventListener('click', function() {
            if (!currentReport) return;
            document.getElementById('newStatus').value = currentReport.status;
            new bootstrap.Modal(document.getElementById('statusModal')).show();
        });

        // Save status change
        document.getElementById('saveStatusBtn').addEventListener('click', async function() {
            if (!currentReport) return;
            
            const statusData = {
                status: document.getElementById('newStatus').value,
                notes: document.getElementById('statusNotes').value
            };
            
            try {
                await adminAPI.updateReportStatus(currentReport.id, statusData);
                showAlert('Status updated successfully', 'success');
                loadReports();
                bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
            } catch (error) {
                showAlert('Error updating status: ' + error.message, 'danger');
            }
        });

        // Add note
        document.getElementById('addNoteBtn').addEventListener('click', function() {
            if (!currentReport) return;
            new bootstrap.Modal(document.getElementById('noteModal')).show();
        });

        // Save note
        document.getElementById('saveNoteBtn').addEventListener('click', async function() {
            if (!currentReport) return;
            
            const noteData = {
                text: document.getElementById('noteText').value,
                type: document.getElementById('noteType').value
            };
            
            try {
                await adminAPI.addReportNote(currentReport.id, noteData);
                showAlert('Note added successfully', 'success');
                loadReports();
                bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
            } catch (error) {
                showAlert('Error adding note: ' + error.message, 'danger');
            }
        });

        // Resolve report
        document.getElementById('resolveBtn').addEventListener('click', async function() {
            if (!currentReport) return;
            
            const resolution = prompt('Enter resolution notes:');
            if (!resolution) return;
            
            try {
                await adminAPI.resolveReport(currentReport.id, resolution);
                showAlert('Report resolved successfully', 'success');
                loadReports();
                bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
            } catch (error) {
                showAlert('Error resolving report: ' + error.message, 'danger');
            }
        });

        // Assign to me
        async function assignToMe() {
            const selectedReports = allReports.filter(r => r.status === 'pending' && !r.assignedTo);
            if (selectedReports.length === 0) {
                showAlert('No unassigned pending reports', 'info');
                return;
            }
            
            try {
                await adminAPI.assignReportsToMe(selectedReports.map(r => r.id));
                showAlert(`Assigned ${selectedReports.length} reports to you`, 'success');
                loadReports();
            } catch (error) {
                showAlert('Error assigning reports: ' + error.message, 'danger');
            }
        }

        // Search and filter
        document.getElementById('reportSearch').addEventListener('input', function() {
            filterReports();
        });

        document.getElementById('statusFilter').addEventListener('change', function() {
            filterReports();
        });

        document.getElementById('priorityFilter').addEventListener('change', function() {
            filterReports();
        });

        document.getElementById('typeFilter').addEventListener('change', function() {
            filterReports();
        });

        function filterReports() {
            const search = document.getElementById('reportSearch').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const priority = document.getElementById('priorityFilter').value;
            const type = document.getElementById('typeFilter').value;

            const filtered = allReports.filter(report => {
                const matchesSearch = report.title.toLowerCase().includes(search) || 
                                    report.description.toLowerCase().includes(search);
                const matchesStatus = !status || report.status === status;
                const matchesPriority = !priority || report.priority === priority;
                const matchesType = !type || report.type === type;
                
                return matchesSearch && matchesStatus && matchesPriority && matchesType;
            });

            renderReports(filtered);
            document.getElementById('reportCount').textContent = filtered.length;
        }

        // Load user info
        const adminUser = JSON.parse(localStorage.getItem('adminUser') || '{}');
        document.getElementById('adminUserName').textContent = adminUser.name || 'Admin User';

        // Initialize
        loadReports();
    </script>
</body>
</html>
