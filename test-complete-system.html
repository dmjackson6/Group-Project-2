<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WasteNaut Complete System Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .test-pass { color: #198754; }
        .test-fail { color: #dc3545; }
        .test-pending { color: #6c757d; }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">üöÄ WasteNaut Complete System Test</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="test-section">
                    <h3>üîß Backend API Tests</h3>
                    <div id="backend-tests">
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing database connection...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing user registration...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing user login...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing donation creation...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing organization management...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing reports system...</span>
                        </div>
                    </div>
                </div>

                <div class="test-section">
                    <h3>üé® Frontend Integration Tests</h3>
                    <div id="frontend-tests">
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing authentication flow...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing role-based navigation...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing dashboard functionality...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing modal interactions...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing API service integration...</span>
                        </div>
                    </div>
                </div>

                <div class="test-section">
                    <h3>ü§ñ AI Integration Tests</h3>
                    <div id="ai-tests">
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing Ollama connection...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing smart matching...</span>
                        </div>
                        <div class="test-item">
                            <span class="test-pending">‚è≥ Testing AI suggestions...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="test-section">
                    <h4>üìä Test Results</h4>
                    <div id="test-summary">
                        <p>Total Tests: <span id="total-tests">0</span></p>
                        <p>Passed: <span id="passed-tests" class="test-pass">0</span></p>
                        <p>Failed: <span id="failed-tests" class="test-fail">0</span></p>
                        <p>Pending: <span id="pending-tests" class="test-pending">0</span></p>
                    </div>
                </div>

                <div class="test-section">
                    <h4>üìù Test Log</h4>
                    <div id="test-log" class="log-area"></div>
                </div>

                <div class="test-section">
                    <button id="run-tests" class="btn btn-primary w-100">Run All Tests</button>
                    <button id="clear-log" class="btn btn-secondary w-100 mt-2">Clear Log</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="frontend/client/resources/scripts/api-service.js"></script>
    <script src="frontend/client/resources/scripts/auth.js"></script>
    
    <script>
        class SystemTester {
            constructor() {
                this.testResults = {
                    total: 0,
                    passed: 0,
                    failed: 0,
                    pending: 0
                };
                this.logElement = document.getElementById('test-log');
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('run-tests').addEventListener('click', () => this.runAllTests());
                document.getElementById('clear-log').addEventListener('click', () => this.clearLog());
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
                logEntry.className = `mb-1 ${type}`;
                this.logElement.appendChild(logEntry);
                this.logElement.scrollTop = this.logElement.scrollHeight;
            }

            clearLog() {
                this.logElement.innerHTML = '';
            }

            updateTestResult(testId, status, message) {
                const testElement = document.querySelector(`#${testId}`);
                if (testElement) {
                    const icon = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚è≥';
                    const className = status === 'pass' ? 'test-pass' : status === 'fail' ? 'test-fail' : 'test-pending';
                    testElement.innerHTML = `<span class="${className}">${icon} ${message}</span>`;
                }

                this.testResults.total++;
                if (status === 'pass') this.testResults.passed++;
                else if (status === 'fail') this.testResults.failed++;
                else this.testResults.pending++;

                this.updateSummary();
            }

            updateSummary() {
                document.getElementById('total-tests').textContent = this.testResults.total;
                document.getElementById('passed-tests').textContent = this.testResults.passed;
                document.getElementById('failed-tests').textContent = this.testResults.failed;
                document.getElementById('pending-tests').textContent = this.testResults.pending;
            }

            async runAllTests() {
                this.log('üöÄ Starting comprehensive system tests...', 'info');
                this.testResults = { total: 0, passed: 0, failed: 0, pending: 0 };
                
                try {
                    await this.testBackendAPIs();
                    await this.testFrontendIntegration();
                    await this.testAIIntegration();
                    
                    this.log('‚úÖ All tests completed!', 'success');
                } catch (error) {
                    this.log(`‚ùå Test suite failed: ${error.message}`, 'error');
                }
            }

            async testBackendAPIs() {
                this.log('üîß Testing Backend APIs...', 'info');

                // Test 1: Database Connection
                try {
                    const healthCheck = await window.apiService.healthCheck();
                    if (healthCheck) {
                        this.updateTestResult('backend-tests', 'pass', 'Database connection successful');
                        this.log('‚úÖ Database connection working', 'success');
                    } else {
                        throw new Error('Health check failed');
                    }
                } catch (error) {
                    this.updateTestResult('backend-tests', 'fail', 'Database connection failed');
                    this.log(`‚ùå Database connection failed: ${error.message}`, 'error');
                }

                // Test 2: User Registration
                try {
                    const testUser = {
                        name: 'Test User',
                        email: `test-${Date.now()}@example.com`,
                        password: 'testpassword123',
                        role: 'individual'
                    };
                    
                    const response = await window.apiService.register(testUser);
                    if (response.token) {
                        this.updateTestResult('backend-tests', 'pass', 'User registration successful');
                        this.log('‚úÖ User registration working', 'success');
                        
                        // Store test user for other tests
                        window.testUser = response.user;
                        window.testToken = response.token;
                    } else {
                        throw new Error('No token received');
                    }
                } catch (error) {
                    this.updateTestResult('backend-tests', 'fail', 'User registration failed');
                    this.log(`‚ùå User registration failed: ${error.message}`, 'error');
                }

                // Test 3: User Login
                try {
                    const loginResponse = await window.apiService.login('test@example.com', 'testpassword123');
                    if (loginResponse.token) {
                        this.updateTestResult('backend-tests', 'pass', 'User login successful');
                        this.log('‚úÖ User login working', 'success');
                    } else {
                        throw new Error('No token received');
                    }
                } catch (error) {
                    this.updateTestResult('backend-tests', 'fail', 'User login failed');
                    this.log(`‚ùå User login failed: ${error.message}`, 'error');
                }

                // Test 4: Donation Creation
                try {
                    const donationData = {
                        title: 'Test Donation',
                        description: 'Test donation for system testing',
                        category: 'Food',
                        quantity: 10,
                        unit: 'items',
                        donorId: 1
                    };
                    
                    const donation = await window.apiService.createDonation(donationData);
                    if (donation.id) {
                        this.updateTestResult('backend-tests', 'pass', 'Donation creation successful');
                        this.log('‚úÖ Donation creation working', 'success');
                    } else {
                        throw new Error('No donation ID received');
                    }
                } catch (error) {
                    this.updateTestResult('backend-tests', 'fail', 'Donation creation failed');
                    this.log(`‚ùå Donation creation failed: ${error.message}`, 'error');
                }

                // Test 5: Organization Management
                try {
                    const orgData = {
                        name: 'Test Organization',
                        type: 'charity',
                        address: '123 Test St',
                        contactEmail: 'test@org.com'
                    };
                    
                    const org = await window.apiService.createOrganization(orgData);
                    if (org.id) {
                        this.updateTestResult('backend-tests', 'pass', 'Organization management successful');
                        this.log('‚úÖ Organization management working', 'success');
                    } else {
                        throw new Error('No organization ID received');
                    }
                } catch (error) {
                    this.updateTestResult('backend-tests', 'fail', 'Organization management failed');
                    this.log(`‚ùå Organization management failed: ${error.message}`, 'error');
                }

                // Test 6: Reports System
                try {
                    const reports = await window.apiService.getReports();
                    if (Array.isArray(reports)) {
                        this.updateTestResult('backend-tests', 'pass', 'Reports system successful');
                        this.log('‚úÖ Reports system working', 'success');
                    } else {
                        throw new Error('Invalid reports response');
                    }
                } catch (error) {
                    this.updateTestResult('backend-tests', 'fail', 'Reports system failed');
                    this.log(`‚ùå Reports system failed: ${error.message}`, 'error');
                }
            }

            async testFrontendIntegration() {
                this.log('üé® Testing Frontend Integration...', 'info');

                // Test 1: Authentication Flow
                try {
                    if (window.authManager) {
                        this.updateTestResult('frontend-tests', 'pass', 'Authentication manager loaded');
                        this.log('‚úÖ Authentication manager working', 'success');
                    } else {
                        throw new Error('AuthManager not found');
                    }
                } catch (error) {
                    this.updateTestResult('frontend-tests', 'fail', 'Authentication manager failed');
                    this.log(`‚ùå Authentication manager failed: ${error.message}`, 'error');
                }

                // Test 2: API Service Integration
                try {
                    if (window.apiService) {
                        this.updateTestResult('frontend-tests', 'pass', 'API service loaded');
                        this.log('‚úÖ API service working', 'success');
                    } else {
                        throw new Error('ApiService not found');
                    }
                } catch (error) {
                    this.updateTestResult('frontend-tests', 'fail', 'API service failed');
                    this.log(`‚ùå API service failed: ${error.message}`, 'error');
                }

                // Test 3: Role-based Navigation
                try {
                    const testUser = { role: 'admin' };
                    window.authManager.currentUser = testUser;
                    
                    if (window.authManager.isAdmin()) {
                        this.updateTestResult('frontend-tests', 'pass', 'Role-based navigation working');
                        this.log('‚úÖ Role-based navigation working', 'success');
                    } else {
                        throw new Error('Role check failed');
                    }
                } catch (error) {
                    this.updateTestResult('frontend-tests', 'fail', 'Role-based navigation failed');
                    this.log(`‚ùå Role-based navigation failed: ${error.message}`, 'error');
                }

                // Test 4: Dashboard Functionality
                try {
                    const dashboardUrl = window.authManager.getDashboardUrl();
                    if (dashboardUrl) {
                        this.updateTestResult('frontend-tests', 'pass', 'Dashboard functionality working');
                        this.log('‚úÖ Dashboard functionality working', 'success');
                    } else {
                        throw new Error('Dashboard URL not generated');
                    }
                } catch (error) {
                    this.updateTestResult('frontend-tests', 'fail', 'Dashboard functionality failed');
                    this.log(`‚ùå Dashboard functionality failed: ${error.message}`, 'error');
                }

                // Test 5: Modal Interactions
                try {
                    // Test if Bootstrap modals are available
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        this.updateTestResult('frontend-tests', 'pass', 'Modal interactions working');
                        this.log('‚úÖ Modal interactions working', 'success');
                    } else {
                        throw new Error('Bootstrap modals not available');
                    }
                } catch (error) {
                    this.updateTestResult('frontend-tests', 'fail', 'Modal interactions failed');
                    this.log(`‚ùå Modal interactions failed: ${error.message}`, 'error');
                }
            }

            async testAIIntegration() {
                this.log('ü§ñ Testing AI Integration...', 'info');

                // Test 1: Ollama Connection
                try {
                    const response = await fetch('http://localhost:11434/api/version');
                    if (response.ok) {
                        this.updateTestResult('ai-tests', 'pass', 'Ollama connection successful');
                        this.log('‚úÖ Ollama connection working', 'success');
                    } else {
                        throw new Error('Ollama not responding');
                    }
                } catch (error) {
                    this.updateTestResult('ai-tests', 'fail', 'Ollama connection failed');
                    this.log(`‚ùå Ollama connection failed: ${error.message}`, 'error');
                }

                // Test 2: Smart Matching
                try {
                    const criteria = {
                        category: 'Food',
                        location: 'Test City',
                        urgency: 'medium'
                    };
                    
                    const matches = await window.apiService.generateMatches(criteria);
                    if (matches) {
                        this.updateTestResult('ai-tests', 'pass', 'Smart matching working');
                        this.log('‚úÖ Smart matching working', 'success');
                    } else {
                        throw new Error('No matches generated');
                    }
                } catch (error) {
                    this.updateTestResult('ai-tests', 'fail', 'Smart matching failed');
                    this.log(`‚ùå Smart matching failed: ${error.message}`, 'error');
                }

                // Test 3: AI Suggestions
                try {
                    const suggestions = await window.apiService.getAISuggestions('test query');
                    if (suggestions) {
                        this.updateTestResult('ai-tests', 'pass', 'AI suggestions working');
                        this.log('‚úÖ AI suggestions working', 'success');
                    } else {
                        throw new Error('No suggestions received');
                    }
                } catch (error) {
                    this.updateTestResult('ai-tests', 'fail', 'AI suggestions failed');
                    this.log(`‚ùå AI suggestions failed: ${error.message}`, 'error');
                }
            }
        }

        // Initialize tester when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.systemTester = new SystemTester();
        });
    </script>
</body>
</html>
