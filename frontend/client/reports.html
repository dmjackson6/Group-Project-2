<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Management - WasteNaut Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../resources/styles/main.css" rel="stylesheet">
</head>
<body>
    <!-- Header Container -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <div class="admin-content">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-gradient">Reports Management</h1>
                    <p class="text-muted">Review and triage user reports, safety concerns, and violations</p>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="reportSearch" placeholder="Search reports...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="investigating">Investigating</option>
                        <option value="resolved">Resolved</option>
                        <option value="dismissed">Dismissed</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="priorityFilter">
                        <option value="">All Priority</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="safety">Safety</option>
                        <option value="fraud">Fraud</option>
                        <option value="inappropriate">Inappropriate</option>
                        <option value="technical">Technical</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="assignToMe()">
                        <i class="bi bi-person-check me-1"></i>Assign to Me
                    </button>
                </div>
            </div>

            <!-- Reports Table -->
            <div class="card" id="all-reports">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-flag me-2"></i>Reports
                        <span class="badge bg-primary ms-2" id="reportCount">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Report</th>
                                    <th>Type</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Reporter</th>
                                    <th>Assigned To</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">Loading reports...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-flag me-2"></i>Report Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="reportModalBody">
                    <!-- Report details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="changeStatusBtn">
                        <i class="bi bi-arrow-repeat me-2"></i>Change Status
                    </button>
                    <button type="button" class="btn btn-info" id="addNoteBtn">
                        <i class="bi bi-chat-text me-2"></i>Add Note
                    </button>
                    <button type="button" class="btn btn-success" id="resolveBtn">
                        <i class="bi bi-check-circle me-2"></i>Resolve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Change Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-arrow-repeat me-2"></i>Change Status
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="statusForm">
                        <div class="mb-3">
                            <label for="newStatus" class="form-label">New Status</label>
                            <select class="form-select" id="newStatus" required>
                                <option value="pending">Pending</option>
                                <option value="investigating">Investigating</option>
                                <option value="resolved">Resolved</option>
                                <option value="dismissed">Dismissed</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="statusNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="statusNotes" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveStatusBtn">
                        <i class="bi bi-save me-2"></i>Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-chat-text me-2"></i>Add Note
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="noteForm">
                        <div class="mb-3">
                            <label for="noteText" class="form-label">Note</label>
                            <textarea class="form-control" id="noteText" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="noteType" class="form-label">Type</label>
                            <select class="form-select" id="noteType">
                                <option value="internal">Internal</option>
                                <option value="public">Public</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNoteBtn">
                        <i class="bi bi-save me-2"></i>Add Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Custom JS -->
    <script src="../resources/scripts/main.js"></script>
    <script src="../resources/scripts/auth.js"></script>
    <script src="../resources/scripts/header-include.js"></script>
    <script src="../resources/scripts/header.js"></script>
    <script>
        // Reports functionality
        let currentReport = null;
        let allReports = [];

        // Page initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Protect this page - only admin users can access
            if (!authManager.protectPage('admin')) {
                return;
            }
            
            // Initialize reports functionality
            loadReports();
        });

        // Mock API for reports
        const mockReportsAPI = {
            async getReports() {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Return mock data
                return [
                    {
                        id: 1,
                        title: "Suspicious Activity Report",
                        description: "User reported suspicious behavior from another user during donation pickup. The user was acting aggressively and not following safety protocols.",
                        type: "safety",
                        priority: "high",
                        status: "pending",
                        reporter: {
                            id: 1,
                            name: "John Doe",
                            email: "john@example.com",
                            phone: "+1-555-0101"
                        },
                        reportedUser: {
                            id: 4,
                            name: "Sarah Wilson",
                            email: "sarah@example.com"
                        },
                        assignedTo: null,
                        createdAt: "2024-01-20T10:15:00Z",
                        updatedAt: "2024-01-20T10:15:00Z",
                        notes: [],
                        evidence: [
                            {
                                type: "text",
                                content: "User was shouting and being confrontational"
                            }
                        ]
                    },
                    {
                        id: 2,
                        title: "Fraudulent Organization",
                        description: "Report of organization providing false information about their registration and capacity. They claim to be a registered charity but verification shows otherwise.",
                        type: "fraud",
                        priority: "critical",
                        status: "investigating",
                        reporter: {
                            id: 3,
                            name: "Mike Johnson",
                            email: "mike@example.com",
                            phone: "+1-555-0303"
                        },
                        reportedUser: {
                            id: 6,
                            name: "Fake Charity",
                            email: "fake@charity.com"
                        },
                        assignedTo: {
                            id: 1,
                            name: "Admin User",
                            email: "admin@wastenaut.test"
                        },
                        createdAt: "2024-01-19T16:30:00Z",
                        updatedAt: "2024-01-19T17:00:00Z",
                        notes: [
                            {
                                id: 1,
                                author: "Admin User",
                                text: "Initial investigation started. Checking registration documents.",
                                type: "internal",
                                createdAt: "2024-01-19T17:00:00Z"
                            }
                        ],
                        evidence: [
                            {
                                type: "document",
                                content: "Screenshot of false registration claim"
                            }
                        ]
                    },
                    {
                        id: 3,
                        title: "Inappropriate Content",
                        description: "User posted inappropriate content in the community forum. Content violates community guidelines.",
                        type: "inappropriate",
                        priority: "medium",
                        status: "resolved",
                        reporter: {
                            id: 2,
                            name: "Jane Smith",
                            email: "jane@example.com",
                            phone: "+1-555-0202"
                        },
                        reportedUser: {
                            id: 7,
                            name: "Inappropriate User",
                            email: "inappropriate@example.com"
                        },
                        assignedTo: {
                            id: 2,
                            name: "Moderator User",
                            email: "moderator@wastenaut.test"
                        },
                        createdAt: "2024-01-18T14:20:00Z",
                        updatedAt: "2024-01-19T09:30:00Z",
                        resolvedAt: "2024-01-19T09:30:00Z",
                        notes: [
                            {
                                id: 2,
                                author: "Moderator User",
                                text: "Content removed and user warned.",
                                type: "public",
                                createdAt: "2024-01-19T09:30:00Z"
                            }
                        ],
                        evidence: [
                            {
                                type: "text",
                                content: "Screenshot of inappropriate post"
                            }
                        ]
                    },
                    {
                        id: 4,
                        title: "Food Safety Violation",
                        description: "Organization reported for distributing expired food items to community members. This poses serious health risks.",
                        type: "safety",
                        priority: "critical",
                        status: "pending",
                        reporter: {
                            id: 5,
                            name: "Lisa Chen",
                            email: "lisa@example.com",
                            phone: "+1-555-0505"
                        },
                        reportedUser: {
                            id: 8,
                            name: "Community Kitchen",
                            email: "kitchen@community.org"
                        },
                        assignedTo: null,
                        createdAt: "2024-01-21T08:45:00Z",
                        updatedAt: "2024-01-21T08:45:00Z",
                        notes: [],
                        evidence: [
                            {
                                type: "document",
                                content: "Photos of expired food items with dates visible"
                            }
                        ]
                    },
                    {
                        id: 5,
                        title: "Harassment Report",
                        description: "User reported being harassed by another user through private messages. Multiple inappropriate messages sent over several days.",
                        type: "harassment",
                        priority: "high",
                        status: "investigating",
                        reporter: {
                            id: 6,
                            name: "Alex Rodriguez",
                            email: "alex@example.com",
                            phone: "+1-555-0606"
                        },
                        reportedUser: {
                            id: 9,
                            name: "Harasser User",
                            email: "harasser@example.com"
                        },
                        assignedTo: {
                            id: 1,
                            name: "Admin User",
                            email: "admin@wastenaut.test"
                        },
                        createdAt: "2024-01-20T15:30:00Z",
                        updatedAt: "2024-01-20T16:00:00Z",
                        notes: [
                            {
                                id: 3,
                                author: "Admin User",
                                text: "Reviewing message history and evidence.",
                                type: "internal",
                                createdAt: "2024-01-20T16:00:00Z"
                            }
                        ],
                        evidence: [
                            {
                                type: "text",
                                content: "Screenshots of harassing messages"
                            }
                        ]
                    }
                ];
            }
        };

        // Show alert notification
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the main content
            const mainContent = document.querySelector('.admin-content .container-fluid');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Load reports
        async function loadReports() {
            try {
                allReports = await mockReportsAPI.getReports();
                renderReports(allReports);
                document.getElementById('reportCount').textContent = allReports.length;
            } catch (error) {
                console.error('Error loading reports:', error);
                showAlert('Error loading reports', 'danger');
            }
        }

        // Render reports table
        function renderReports(reports) {
            const tbody = document.getElementById('reportsTable');
            tbody.innerHTML = reports.map(report => `
                <tr>
                    <td>
                        <div>
                            <div class="fw-bold">${report.title}</div>
                            <small class="text-muted">ID: ${report.id}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${report.type === 'safety' ? 'danger' : report.type === 'fraud' ? 'warning' : report.type === 'inappropriate' ? 'info' : 'secondary'}">
                            ${report.type}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${report.priority === 'critical' ? 'danger' : report.priority === 'high' ? 'warning' : report.priority === 'medium' ? 'info' : 'secondary'}">
                            ${report.priority}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${report.status === 'resolved' ? 'success' : report.status === 'investigating' ? 'warning' : report.status === 'dismissed' ? 'secondary' : 'primary'}">
                            ${report.status}
                        </span>
                    </td>
                    <td>
                        <div>${report.reporter.name}</div>
                        <small class="text-muted">${report.reporter.email}</small>
                    </td>
                    <td>
                        ${report.assignedTo ? report.assignedTo.name : '<span class="text-muted">Unassigned</span>'}
                    </td>
                    <td>${new Date(report.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewReport(${report.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // View report details
        async function viewReport(reportId) {
            try {
                currentReport = allReports.find(r => r.id === reportId);
                if (!currentReport) return;

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const reportDetails = currentReport;
                
                document.getElementById('reportModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Report Details</h6>
                            <div class="mb-3">
                                <strong>Title:</strong> ${reportDetails.title}
                            </div>
                            <div class="mb-3">
                                <strong>Description:</strong><br>
                                <div class="bg-light p-3 rounded">${reportDetails.description}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Type:</strong> 
                                    <span class="badge bg-${reportDetails.type === 'safety' ? 'danger' : reportDetails.type === 'fraud' ? 'warning' : reportDetails.type === 'inappropriate' ? 'info' : 'secondary'}">
                                        ${reportDetails.type}
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Priority:</strong> 
                                    <span class="badge bg-${reportDetails.priority === 'critical' ? 'danger' : reportDetails.priority === 'high' ? 'warning' : reportDetails.priority === 'medium' ? 'info' : 'secondary'}">
                                        ${reportDetails.priority}
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Status:</strong> 
                                    <span class="badge bg-${reportDetails.status === 'resolved' ? 'success' : reportDetails.status === 'investigating' ? 'warning' : reportDetails.status === 'dismissed' ? 'secondary' : 'primary'}">
                                        ${reportDetails.status}
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Assigned To:</strong> 
                                    ${reportDetails.assignedTo ? reportDetails.assignedTo.name : 'Unassigned'}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Reporter Information</h6>
                            <div class="mb-2">
                                <strong>Name:</strong> ${reportDetails.reporter.name}
                            </div>
                            <div class="mb-2">
                                <strong>Email:</strong> ${reportDetails.reporter.email}
                            </div>
                            <div class="mb-2">
                                <strong>Phone:</strong> ${reportDetails.reporter.phone || 'Not provided'}
                            </div>
                            <div class="mb-3">
                                <strong>Reported:</strong> ${new Date(reportDetails.createdAt).toLocaleString()}
                            </div>
                            
                            <h6 class="mt-4">Notes</h6>
                            <div id="reportNotes">
                                ${reportDetails.notes.map(note => `
                                    <div class="card mb-2">
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">${note.author}</small>
                                                <small class="text-muted">${new Date(note.createdAt).toLocaleString()}</small>
                                            </div>
                                            <div class="mt-1">${note.text}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                new bootstrap.Modal(document.getElementById('reportModal')).show();
            } catch (error) {
                console.error('Error loading report details:', error);
                showAlert('Error loading report details', 'danger');
            }
        }

        // Change status
        document.getElementById('changeStatusBtn').addEventListener('click', function() {
            if (!currentReport) return;
            document.getElementById('newStatus').value = currentReport.status;
            new bootstrap.Modal(document.getElementById('statusModal')).show();
        });

        // Save status change
        document.getElementById('saveStatusBtn').addEventListener('click', async function() {
            if (!currentReport) return;
            
            const statusData = {
                status: document.getElementById('newStatus').value,
                notes: document.getElementById('statusNotes').value
            };
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Update the report in memory
                currentReport.status = statusData.status;
                currentReport.updatedAt = new Date().toISOString();
                
                showAlert('Status updated successfully', 'success');
                renderReports(allReports);
                bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
            } catch (error) {
                showAlert('Error updating status: ' + error.message, 'danger');
            }
        });

        // Add note
        document.getElementById('addNoteBtn').addEventListener('click', function() {
            if (!currentReport) return;
            new bootstrap.Modal(document.getElementById('noteModal')).show();
        });

        // Save note
        document.getElementById('saveNoteBtn').addEventListener('click', async function() {
            if (!currentReport) return;
            
            const noteData = {
                text: document.getElementById('noteText').value,
                type: document.getElementById('noteType').value
            };
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Add note to the report in memory
                const newNote = {
                    id: Date.now(),
                    author: "Admin User",
                    text: noteData.text,
                    type: noteData.type,
                    createdAt: new Date().toISOString()
                };
                currentReport.notes.push(newNote);
                currentReport.updatedAt = new Date().toISOString();
                
                showAlert('Note added successfully', 'success');
                renderReports(allReports);
                bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
            } catch (error) {
                showAlert('Error adding note: ' + error.message, 'danger');
            }
        });

        // Resolve report
        document.getElementById('resolveBtn').addEventListener('click', async function() {
            if (!currentReport) return;
            
            const resolution = prompt('Enter resolution notes:');
            if (!resolution) return;
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Update the report in memory
                currentReport.status = 'resolved';
                currentReport.resolvedAt = new Date().toISOString();
                currentReport.updatedAt = new Date().toISOString();
                
                showAlert('Report resolved successfully', 'success');
                renderReports(allReports);
                bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
            } catch (error) {
                showAlert('Error resolving report: ' + error.message, 'danger');
            }
        });

        // Assign to me
        async function assignToMe() {
            const selectedReports = allReports.filter(r => r.status === 'pending' && !r.assignedTo);
            if (selectedReports.length === 0) {
                showAlert('No unassigned pending reports', 'info');
                return;
            }
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Update the reports in memory
                selectedReports.forEach(report => {
                    report.assignedTo = {
                        id: 1,
                        name: "Admin User",
                        email: "admin@wastenaut.test"
                    };
                    report.updatedAt = new Date().toISOString();
                });
                
                showAlert(`Assigned ${selectedReports.length} reports to you`, 'success');
                renderReports(allReports);
            } catch (error) {
                showAlert('Error assigning reports: ' + error.message, 'danger');
            }
        }

        // Search and filter
        document.getElementById('reportSearch').addEventListener('input', function() {
            filterReports();
        });

        document.getElementById('statusFilter').addEventListener('change', function() {
            filterReports();
        });

        document.getElementById('priorityFilter').addEventListener('change', function() {
            filterReports();
        });

        document.getElementById('typeFilter').addEventListener('change', function() {
            filterReports();
        });

        function filterReports() {
            const search = document.getElementById('reportSearch').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const priority = document.getElementById('priorityFilter').value;
            const type = document.getElementById('typeFilter').value;

            const filtered = allReports.filter(report => {
                const matchesSearch = report.title.toLowerCase().includes(search) || 
                                    report.description.toLowerCase().includes(search);
                const matchesStatus = !status || report.status === status;
                const matchesPriority = !priority || report.priority === priority;
                const matchesType = !type || report.type === type;
                
                return matchesSearch && matchesStatus && matchesPriority && matchesType;
            });

            renderReports(filtered);
            document.getElementById('reportCount').textContent = filtered.length;
        }

    </script>
</body>
</html>
