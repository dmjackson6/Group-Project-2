<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Management - WasteNaut Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../Resources/Styles/main.css" rel="stylesheet">
    <link href="../Resources/Styles/admin.css" rel="stylesheet">
</head>
<body>
    <!-- Admin Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark admin-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-rocket-takeoff me-2"></i>WasteNaut Admin
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="adminNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people me-1"></i>Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="orgs.html">
                            <i class="bi bi-building me-1"></i>Organizations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <i class="bi bi-flag me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="matches.html">
                            <i class="bi bi-diagram-3 me-1"></i>Matches
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">
                            <i class="bi bi-gear me-1"></i>Settings
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="adminUserName">Admin User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="adminAPI.logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="admin-content">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-gradient">Organization Management</h1>
                    <p class="text-muted">Manage organization accounts, approvals, and capacity settings</p>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="orgSearch" placeholder="Search organizations...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="approved">Approved</option>
                        <option value="pending">Pending</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="foodbank">Food Bank</option>
                        <option value="charity">Charity</option>
                        <option value="restaurant">Restaurant</option>
                    </select>
                </div>
            </div>

            <!-- Organizations Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-building me-2"></i>Organizations
                        <span class="badge bg-primary ms-2" id="orgCount">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Organization</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Capacity</th>
                                    <th>Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orgsTable">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Loading organizations...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Organization Profile Modal -->
    <div class="modal fade" id="orgModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-building me-2"></i>Organization Profile
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orgModalBody">
                    <!-- Organization details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="rejectOrgBtn">
                        <i class="bi bi-x-circle me-2"></i>Reject
                    </button>
                    <button type="button" class="btn btn-success" id="approveOrgBtn">
                        <i class="bi bi-check-circle me-2"></i>Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Capacity Settings Modal -->
    <div class="modal fade" id="capacityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-sliders me-2"></i>Set Capacity
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="capacityForm">
                        <div class="mb-3">
                            <label for="maxCapacity" class="form-label">Maximum Capacity</label>
                            <input type="number" class="form-control" id="maxCapacity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="currentCapacity" class="form-label">Current Usage</label>
                            <input type="number" class="form-control" id="currentCapacity" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="capacityNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="capacityNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCapacityBtn">
                        <i class="bi bi-save me-2"></i>Save Capacity
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../Resources/Scripts/main.js"></script>
    <script src="admin-main.js"></script>
    <script src="mock-api.js"></script>
    <script>
        let currentOrg = null;
        let allOrgs = [];

        // Check authentication
        if (!localStorage.getItem('adminToken')) {
            window.location.href = 'login.html';
        }

        // Load organizations
        async function loadOrganizations() {
            try {
                allOrgs = await adminAPI.getOrganizations();
                renderOrganizations(allOrgs);
                document.getElementById('orgCount').textContent = allOrgs.length;
            } catch (error) {
                console.error('Error loading organizations:', error);
                showAlert('Error loading organizations', 'danger');
            }
        }

        // Render organizations table
        function renderOrganizations(orgs) {
            const tbody = document.getElementById('orgsTable');
            tbody.innerHTML = orgs.map(org => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3">
                                <i class="bi bi-building"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${org.name}</div>
                                <small class="text-muted">ID: ${org.id}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${org.type === 'foodbank' ? 'primary' : org.type === 'charity' ? 'info' : 'warning'}">
                            ${org.type}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${org.status === 'approved' ? 'success' : org.status === 'pending' ? 'warning' : 'danger'}">
                            ${org.status}
                        </span>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-${org.capacity.used / org.capacity.max > 0.8 ? 'danger' : org.capacity.used / org.capacity.max > 0.6 ? 'warning' : 'success'}" 
                                 style="width: ${(org.capacity.used / org.capacity.max) * 100}%">
                                ${org.capacity.used}/${org.capacity.max}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${org.contact.name}</div>
                        <small class="text-muted">${org.contact.email}</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrg(${org.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="setCapacity(${org.id})">
                            <i class="bi bi-sliders"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // View organization details
        async function viewOrg(orgId) {
            try {
                currentOrg = allOrgs.find(o => o.id === orgId);
                if (!currentOrg) return;

                const orgDetails = await adminAPI.getOrganization(orgId);
                
                document.getElementById('orgModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Organization Details</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Name:</strong></td>
                                    <td>${orgDetails.name}</td>
                                </tr>
                                <tr>
                                    <td><strong>Type:</strong></td>
                                    <td><span class="badge bg-${orgDetails.type === 'foodbank' ? 'primary' : orgDetails.type === 'charity' ? 'info' : 'warning'}">${orgDetails.type}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td><span class="badge bg-${orgDetails.status === 'approved' ? 'success' : orgDetails.status === 'pending' ? 'warning' : 'danger'}">${orgDetails.status}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Registration:</strong></td>
                                    <td>${orgDetails.registrationNumber}</td>
                                </tr>
                                <tr>
                                    <td><strong>Address:</strong></td>
                                    <td>${orgDetails.address}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Contact Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Contact:</strong></td>
                                    <td>${orgDetails.contact.name}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>${orgDetails.contact.email}</td>
                                </tr>
                                <tr>
                                    <td><strong>Phone:</strong></td>
                                    <td>${orgDetails.contact.phone}</td>
                                </tr>
                                <tr>
                                    <td><strong>Capacity:</strong></td>
                                    <td>${orgDetails.capacity.used}/${orgDetails.capacity.max} (${Math.round((orgDetails.capacity.used / orgDetails.capacity.max) * 100)}%)</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Service Areas</h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${orgDetails.serviceAreas.map(area => `<span class="badge bg-secondary">${area}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;

                // Update action buttons
                const approveBtn = document.getElementById('approveOrgBtn');
                const rejectBtn = document.getElementById('rejectOrgBtn');
                
                approveBtn.style.display = orgDetails.status === 'pending' ? 'inline-block' : 'none';
                rejectBtn.style.display = orgDetails.status === 'pending' ? 'inline-block' : 'none';

                new bootstrap.Modal(document.getElementById('orgModal')).show();
            } catch (error) {
                console.error('Error loading organization details:', error);
                showAlert('Error loading organization details', 'danger');
            }
        }

        // Approve organization
        document.getElementById('approveOrgBtn').addEventListener('click', async function() {
            if (!currentOrg) return;
            
            try {
                await adminAPI.approveOrganization(currentOrg.id);
                showAlert('Organization approved successfully', 'success');
                loadOrganizations();
                bootstrap.Modal.getInstance(document.getElementById('orgModal')).hide();
            } catch (error) {
                showAlert('Error approving organization: ' + error.message, 'danger');
            }
        });

        // Reject organization
        document.getElementById('rejectOrgBtn').addEventListener('click', async function() {
            if (!currentOrg) return;
            
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;
            
            try {
                await adminAPI.rejectOrganization(currentOrg.id, reason);
                showAlert('Organization rejected', 'info');
                loadOrganizations();
                bootstrap.Modal.getInstance(document.getElementById('orgModal')).hide();
            } catch (error) {
                showAlert('Error rejecting organization: ' + error.message, 'danger');
            }
        });

        // Set capacity
        function setCapacity(orgId) {
            currentOrg = allOrgs.find(o => o.id === orgId);
            if (!currentOrg) return;

            document.getElementById('maxCapacity').value = currentOrg.capacity.max;
            document.getElementById('currentCapacity').value = currentOrg.capacity.used;
            document.getElementById('capacityNotes').value = currentOrg.capacity.notes || '';
            
            new bootstrap.Modal(document.getElementById('capacityModal')).show();
        }

        // Save capacity
        document.getElementById('saveCapacityBtn').addEventListener('click', async function() {
            if (!currentOrg) return;
            
            const capacityData = {
                max: parseInt(document.getElementById('maxCapacity').value),
                used: parseInt(document.getElementById('currentCapacity').value),
                notes: document.getElementById('capacityNotes').value
            };
            
            try {
                await adminAPI.setOrganizationCapacity(currentOrg.id, capacityData);
                showAlert('Capacity updated successfully', 'success');
                loadOrganizations();
                bootstrap.Modal.getInstance(document.getElementById('capacityModal')).hide();
            } catch (error) {
                showAlert('Error updating capacity: ' + error.message, 'danger');
            }
        });

        // Search and filter
        document.getElementById('orgSearch').addEventListener('input', function() {
            filterOrganizations();
        });

        document.getElementById('statusFilter').addEventListener('change', function() {
            filterOrganizations();
        });

        document.getElementById('typeFilter').addEventListener('change', function() {
            filterOrganizations();
        });

        function filterOrganizations() {
            const search = document.getElementById('orgSearch').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;

            const filtered = allOrgs.filter(org => {
                const matchesSearch = org.name.toLowerCase().includes(search) || 
                                    org.contact.name.toLowerCase().includes(search);
                const matchesStatus = !status || org.status === status;
                const matchesType = !type || org.type === type;
                
                return matchesSearch && matchesStatus && matchesType;
            });

            renderOrganizations(filtered);
            document.getElementById('orgCount').textContent = filtered.length;
        }

        // Load user info
        const adminUser = JSON.parse(localStorage.getItem('adminUser') || '{}');
        document.getElementById('adminUserName').textContent = adminUser.name || 'Admin User';

        // Initialize
        loadOrganizations();
    </script>
</body>
</html>
