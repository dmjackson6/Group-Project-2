<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Matches - WasteNaut Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../Resources/Styles/main.css" rel="stylesheet">
    <link href="../Resources/Styles/admin.css" rel="stylesheet">
</head>
<body>
    <!-- Admin Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark admin-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-rocket-takeoff me-2"></i>WasteNaut Admin
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="adminNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people me-1"></i>Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orgs.html">
                            <i class="bi bi-building me-1"></i>Organizations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <i class="bi bi-flag me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="matches.html">
                            <i class="bi bi-diagram-3 me-1"></i>Matches
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">
                            <i class="bi bi-gear me-1"></i>Settings
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="adminUserName">Admin User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="adminAPI.logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="admin-content">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-gradient">AI Match Management</h1>
                    <p class="text-muted">Review AI-generated matches, confidence scores, and manual overrides</p>
                </div>
            </div>

            <!-- AI Metrics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card kpi-card">
                        <div class="card-body text-center">
                            <i class="bi bi-robot text-primary" style="font-size: 2rem;"></i>
                            <h4 class="mt-2" id="totalMatches">-</h4>
                            <p class="text-muted mb-0">Total Matches</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card kpi-card">
                        <div class="card-body text-center">
                            <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                            <h4 class="mt-2" id="acceptedMatches">-</h4>
                            <p class="text-muted mb-0">Accepted</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card kpi-card">
                        <div class="card-body text-center">
                            <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                            <h4 class="mt-2" id="rejectedMatches">-</h4>
                            <p class="text-muted mb-0">Rejected</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card kpi-card">
                        <div class="card-body text-center">
                            <i class="bi bi-graph-up text-info" style="font-size: 2rem;"></i>
                            <h4 class="mt-2" id="avgConfidence">-</h4>
                            <p class="text-muted mb-0">Avg Confidence</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="matchSearch" placeholder="Search matches...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="accepted">Accepted</option>
                        <option value="rejected">Rejected</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="confidenceFilter">
                        <option value="">All Confidence</option>
                        <option value="high">High (90%+)</option>
                        <option value="medium">Medium (70-89%)</option>
                        <option value="low">Low (<70%)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="donation">Donation</option>
                        <option value="request">Request</option>
                        <option value="volunteer">Volunteer</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="generateNewMatches()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Generate
                    </button>
                </div>
            </div>

            <!-- Matches Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-diagram-3 me-2"></i>AI Matches
                        <span class="badge bg-primary ms-2" id="matchCount">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Match</th>
                                    <th>Type</th>
                                    <th>Confidence</th>
                                    <th>Status</th>
                                    <th>Parties</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="matchesTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Loading matches...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Match Details Modal -->
    <div class="modal fade" id="matchModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-diagram-3 me-2"></i>Match Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="matchModalBody">
                    <!-- Match details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="rejectMatchBtn">
                        <i class="bi bi-x-circle me-2"></i>Reject
                    </button>
                    <button type="button" class="btn btn-success" id="acceptMatchBtn">
                        <i class="bi bi-check-circle me-2"></i>Accept
                    </button>
                    <button type="button" class="btn btn-warning" id="overrideMatchBtn">
                        <i class="bi bi-gear me-2"></i>Override
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Override Match Modal -->
    <div class="modal fade" id="overrideModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear me-2"></i>Override Match
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="overrideForm">
                        <div class="mb-3">
                            <label for="overrideReason" class="form-label">Override Reason</label>
                            <select class="form-select" id="overrideReason" required>
                                <option value="">Select reason...</option>
                                <option value="better_match">Better match available</option>
                                <option value="inappropriate">Inappropriate match</option>
                                <option value="user_request">User request</option>
                                <option value="system_error">System error</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="overrideNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="overrideNotes" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newConfidence" class="form-label">New Confidence Score</label>
                            <input type="range" class="form-range" id="newConfidence" min="0" max="100" value="50">
                            <div class="d-flex justify-content-between">
                                <small>0%</small>
                                <span id="confidenceValue">50%</span>
                                <small>100%</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveOverrideBtn">
                        <i class="bi bi-save me-2"></i>Save Override
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../Resources/Scripts/main.js"></script>
    <script src="admin-main.js"></script>
    <script src="mock-api.js"></script>
    <script>
        let currentMatch = null;
        let allMatches = [];

        // Check authentication
        if (!localStorage.getItem('adminToken')) {
            window.location.href = 'login.html';
        }

        // Load matches
        async function loadMatches() {
            try {
                allMatches = await adminAPI.getMatches();
                renderMatches(allMatches);
                updateMetrics(allMatches);
                document.getElementById('matchCount').textContent = allMatches.length;
            } catch (error) {
                console.error('Error loading matches:', error);
                showAlert('Error loading matches', 'danger');
            }
        }

        // Update metrics
        function updateMetrics(matches) {
            const total = matches.length;
            const accepted = matches.filter(m => m.status === 'accepted').length;
            const rejected = matches.filter(m => m.status === 'rejected').length;
            const avgConfidence = matches.length > 0 ? 
                Math.round(matches.reduce((sum, m) => sum + m.confidence, 0) / matches.length) : 0;

            document.getElementById('totalMatches').textContent = total;
            document.getElementById('acceptedMatches').textContent = accepted;
            document.getElementById('rejectedMatches').textContent = rejected;
            document.getElementById('avgConfidence').textContent = avgConfidence + '%';
        }

        // Render matches table
        function renderMatches(matches) {
            const tbody = document.getElementById('matchesTable');
            tbody.innerHTML = matches.map(match => `
                <tr>
                    <td>
                        <div>
                            <div class="fw-bold">${match.title}</div>
                            <small class="text-muted">ID: ${match.id}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${match.type === 'donation' ? 'success' : match.type === 'request' ? 'info' : 'warning'}">
                            ${match.type}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 60px; height: 8px;">
                                <div class="progress-bar bg-${match.confidence >= 90 ? 'success' : match.confidence >= 70 ? 'warning' : 'danger'}" 
                                     style="width: ${match.confidence}%"></div>
                            </div>
                            <small>${match.confidence}%</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${match.status === 'accepted' ? 'success' : match.status === 'rejected' ? 'danger' : match.status === 'expired' ? 'secondary' : 'primary'}">
                            ${match.status}
                        </span>
                    </td>
                    <td>
                        <div class="small">
                            <div><strong>From:</strong> ${match.from.name}</div>
                            <div><strong>To:</strong> ${match.to.name}</div>
                        </div>
                    </td>
                    <td>${new Date(match.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewMatch(${match.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // View match details
        async function viewMatch(matchId) {
            try {
                currentMatch = allMatches.find(m => m.id === matchId);
                if (!currentMatch) return;

                const matchDetails = await adminAPI.getMatch(matchId);
                
                document.getElementById('matchModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Match Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Title:</strong></td>
                                    <td>${matchDetails.title}</td>
                                </tr>
                                <tr>
                                    <td><strong>Type:</strong></td>
                                    <td><span class="badge bg-${matchDetails.type === 'donation' ? 'success' : matchDetails.type === 'request' ? 'info' : 'warning'}">${matchDetails.type}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Confidence:</strong></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="width: 100px; height: 10px;">
                                                <div class="progress-bar bg-${matchDetails.confidence >= 90 ? 'success' : matchDetails.confidence >= 70 ? 'warning' : 'danger'}" 
                                                     style="width: ${matchDetails.confidence}%"></div>
                                            </div>
                                            <span>${matchDetails.confidence}%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td><span class="badge bg-${matchDetails.status === 'accepted' ? 'success' : matchDetails.status === 'rejected' ? 'danger' : matchDetails.status === 'expired' ? 'secondary' : 'primary'}">${matchDetails.status}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Created:</strong></td>
                                    <td>${new Date(matchDetails.createdAt).toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>AI Analysis</h6>
                            <div class="mb-3">
                                <strong>Matching Factors:</strong>
                                <ul class="mt-2">
                                    ${matchDetails.factors.map(factor => `
                                        <li>
                                            <span class="badge bg-info me-2">${factor.weight}%</span>
                                            ${factor.description}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div class="mb-3">
                                <strong>AI Notes:</strong>
                                <div class="bg-light p-2 rounded">${matchDetails.aiNotes}</div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>From Party</h6>
                            <div class="card">
                                <div class="card-body">
                                    <h6>${matchDetails.from.name}</h6>
                                    <p class="text-muted">${matchDetails.from.type}</p>
                                    <p><strong>Location:</strong> ${matchDetails.from.location}</p>
                                    <p><strong>Contact:</strong> ${matchDetails.from.contact}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>To Party</h6>
                            <div class="card">
                                <div class="card-body">
                                    <h6>${matchDetails.to.name}</h6>
                                    <p class="text-muted">${matchDetails.to.type}</p>
                                    <p><strong>Location:</strong> ${matchDetails.to.location}</p>
                                    <p><strong>Contact:</strong> ${matchDetails.to.contact}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Update action buttons
                const acceptBtn = document.getElementById('acceptMatchBtn');
                const rejectBtn = document.getElementById('rejectMatchBtn');
                const overrideBtn = document.getElementById('overrideMatchBtn');
                
                acceptBtn.style.display = matchDetails.status === 'pending' ? 'inline-block' : 'none';
                rejectBtn.style.display = matchDetails.status === 'pending' ? 'inline-block' : 'none';
                overrideBtn.style.display = 'inline-block';

                new bootstrap.Modal(document.getElementById('matchModal')).show();
            } catch (error) {
                console.error('Error loading match details:', error);
                showAlert('Error loading match details', 'danger');
            }
        }

        // Accept match
        document.getElementById('acceptMatchBtn').addEventListener('click', async function() {
            if (!currentMatch) return;
            
            try {
                await adminAPI.acceptMatch(currentMatch.id);
                showAlert('Match accepted successfully', 'success');
                loadMatches();
                bootstrap.Modal.getInstance(document.getElementById('matchModal')).hide();
            } catch (error) {
                showAlert('Error accepting match: ' + error.message, 'danger');
            }
        });

        // Reject match
        document.getElementById('rejectMatchBtn').addEventListener('click', async function() {
            if (!currentMatch) return;
            
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;
            
            try {
                await adminAPI.rejectMatch(currentMatch.id, reason);
                showAlert('Match rejected', 'info');
                loadMatches();
                bootstrap.Modal.getInstance(document.getElementById('matchModal')).hide();
            } catch (error) {
                showAlert('Error rejecting match: ' + error.message, 'danger');
            }
        });

        // Override match
        document.getElementById('overrideMatchBtn').addEventListener('click', function() {
            if (!currentMatch) return;
            new bootstrap.Modal(document.getElementById('overrideModal')).show();
        });

        // Save override
        document.getElementById('saveOverrideBtn').addEventListener('click', async function() {
            if (!currentMatch) return;
            
            const overrideData = {
                reason: document.getElementById('overrideReason').value,
                notes: document.getElementById('overrideNotes').value,
                newConfidence: parseInt(document.getElementById('newConfidence').value)
            };
            
            try {
                await adminAPI.overrideMatch(currentMatch.id, overrideData);
                showAlert('Match overridden successfully', 'success');
                loadMatches();
                bootstrap.Modal.getInstance(document.getElementById('overrideModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('matchModal')).hide();
            } catch (error) {
                showAlert('Error overriding match: ' + error.message, 'danger');
            }
        });

        // Generate new matches
        async function generateNewMatches() {
            try {
                const result = await adminAPI.generateMatches();
                showAlert(`Generated ${result.count} new matches`, 'success');
                loadMatches();
            } catch (error) {
                showAlert('Error generating matches: ' + error.message, 'danger');
            }
        }

        // Confidence slider
        document.getElementById('newConfidence').addEventListener('input', function() {
            document.getElementById('confidenceValue').textContent = this.value + '%';
        });

        // Search and filter
        document.getElementById('matchSearch').addEventListener('input', function() {
            filterMatches();
        });

        document.getElementById('statusFilter').addEventListener('change', function() {
            filterMatches();
        });

        document.getElementById('confidenceFilter').addEventListener('change', function() {
            filterMatches();
        });

        document.getElementById('typeFilter').addEventListener('change', function() {
            filterMatches();
        });

        function filterMatches() {
            const search = document.getElementById('matchSearch').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const confidence = document.getElementById('confidenceFilter').value;
            const type = document.getElementById('typeFilter').value;

            const filtered = allMatches.filter(match => {
                const matchesSearch = match.title.toLowerCase().includes(search);
                const matchesStatus = !status || match.status === status;
                const matchesConfidence = !confidence || 
                    (confidence === 'high' && match.confidence >= 90) ||
                    (confidence === 'medium' && match.confidence >= 70 && match.confidence < 90) ||
                    (confidence === 'low' && match.confidence < 70);
                const matchesType = !type || match.type === type;
                
                return matchesSearch && matchesStatus && matchesConfidence && matchesType;
            });

            renderMatches(filtered);
            document.getElementById('matchCount').textContent = filtered.length;
        }

        // Load user info
        const adminUser = JSON.parse(localStorage.getItem('adminUser') || '{}');
        document.getElementById('adminUserName').textContent = adminUser.name || 'Admin User';

        // Initialize
        loadMatches();
    </script>
</body>
</html>
